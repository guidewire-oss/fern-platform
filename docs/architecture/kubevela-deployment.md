# Fern Platform KubeVela Deployment

## Overview

Fern Platform uses KubeVela to simplify Kubernetes deployment. KubeVela provides an application-centric abstraction that hides Kubernetes complexity while maintaining flexibility.

## Architecture Diagram

```
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                           User Access                                   │
    │                      Web Browser (Port 8080)                            │
    └─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                     KubeVela Application Model                          │
    │                                                                         │
    │  Components (What):           Traits (How):                            │
    │  ❏ fern-platform            ❏ gateway (ingress routing)               │
    │    type: webservice         ❏ service-binding (DB credentials)        │
    │  ❏ postgres                                                            │
    │    type: cloud-native-postgres                                         │
    │  ❏ redis                                                               │
    │    type: webservice                                                    │
    │  ❏ keycloak                                                            │
    │    type: webservice                                                    │
    └─────────────────────────────────────────────────────────────────────────┘
                                    │
                       KubeVela Controller Renders
                                    ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                   Kubernetes Resources (Generated)                      │
    │                                                                         │
    │  ❏ Deployments: fern-platform, redis, keycloak                        │
    │  ❏ PostgreSQL Cluster (CloudNativePG CRD)                             │
    │  ❏ Services & Ingress Rules (Traefik)                                 │
    │  ❏ ConfigMap: keycloak-realm-config                                   │
    │  ❏ Secret: postgres-app (auto-generated by CNPG)                      │
    └─────────────────────────────────────────────────────────────────────────┘
```

## Components

### 1. fern-platform (Main Application)
```yaml
- name: fern-platform
  type: webservice
  properties:
    image: ghcr.io/guidewire-oss/fern-platform:latest
    ports:
      - port: 8080
```
- **Type**: `webservice` - KubeVela's built-in type for web applications
- **Creates**: Deployment, Service
- **Purpose**: REST/GraphQL APIs and web UI

### 2. postgres (Database)
```yaml
- name: postgres
  type: cloud-native-postgres
  properties:
    instances: 1
    storageSize: 0.5Gi
```
- **Type**: `cloud-native-postgres` - Maps to CloudNativePG CRD
- **Creates**: PostgreSQL Cluster, PVC, Secret (postgres-app)
- **Purpose**: Persistent storage for all application data

### 3. redis (Cache)
```yaml
- name: redis
  type: webservice
  properties:
    image: redis:7-alpine
    ports:
      - port: 6379
```
- **Type**: `webservice` - Simple container deployment
- **Creates**: Deployment, Service
- **Purpose**: Session storage and caching

### 4. keycloak (OAuth Provider)
```yaml
- name: keycloak
  type: webservice
  properties:
    image: quay.io/keycloak/keycloak:23.0
    cmd: ["/opt/keycloak/bin/kc.sh", "start-dev"]
```
- **Type**: `webservice` with volume mounts
- **Creates**: Deployment, Service, uses ConfigMap
- **Purpose**: OAuth 2.0/OpenID Connect authentication

## Traits

### gateway Trait
```yaml
traits:
  - type: gateway
    properties:
      domain: fern-platform.local
      http:
        "/": 8080
      class: traefik
```
- **Purpose**: Creates Ingress rules for external access
- **Applied to**: fern-platform and keycloak components

### service-binding Trait
```yaml
traits:
  - type: service-binding
    properties:
      envMappings:
        DB_USER:
          secret: postgres-app
          key: username
```
- **Purpose**: Injects database credentials from secret
- **Applied to**: fern-platform component only

## Deployment Workflow

The deployment follows a specific order defined in the workflow section:

```yaml
workflow:
  steps:
    1. deploy-database        # PostgreSQL first
    2. deploy-redis          # Redis cache
    3. deploy-keycloak-config # ConfigMap with realm data
    4. deploy-keycloak       # OAuth provider
    5. wait-for-infrastructure # 45s pause
    6. deploy-application    # Main app last
```

This ensures dependencies are ready before the main application starts.

## What Actually Gets Deployed

### Kubernetes Resources Created:

1. **Namespace**: `fern-platform`

2. **Deployments**:
   - `fern-platform` (main app)
   - `redis` (cache)
   - `keycloak` (auth)

3. **PostgreSQL Cluster** (via CloudNativePG):
   - Custom resource: `clusters.postgresql.cnpg.io`
   - Creates pods: `postgres-1`
   - Auto-generates secret: `postgres-app`

4. **Services**:
   - `fern-platform` (ClusterIP)
   - `redis` (ClusterIP)
   - `keycloak` (ClusterIP)
   - `postgres-rw` (ClusterIP, created by CNPG)

5. **Ingress** (via Traefik):
   - `fern-platform.local` → fern-platform:8080
   - `keycloak` → keycloak:8080

6. **ConfigMap**:
   - `keycloak-realm-config` (OAuth configuration and test users)

7. **Secrets**:
   - `postgres-app` (database credentials, auto-generated)

## Prerequisites

1. **k3d cluster** with port mappings:
   ```bash
   k3d cluster create fern-platform -p "8080:8080@loadbalancer"
   ```

2. **KubeVela** installed:
   ```bash
   helm install kubevela vela-core \
     --repo https://kubevela.github.io/charts \
     --namespace vela-system --create-namespace
   ```

3. **CloudNativePG operator** installed:
   ```bash
   helm install cnpg cloudnative-pg \
     --repo https://cloudnative-pg.github.io/charts \
     --namespace cnpg-system --create-namespace
   ```

4. **/etc/hosts entries**:
   ```
   127.0.0.1 fern-platform.local
   127.0.0.1 keycloak
   ```

## Deployment Commands

```bash
# Using Makefile (recommended)
make deploy-all

# Or manually
kubectl create namespace fern-platform
kubectl apply -f deployments/fern-platform-kubevela.yaml

# Check status
vela status fern-platform -n fern-platform
kubectl get all -n fern-platform

# Access application
open http://fern-platform.local:8080
```

## Troubleshooting

### PostgreSQL Issues
```bash
# Check CNPG operator
kubectl get pods -n cnpg-system

# Check PostgreSQL cluster
kubectl describe cluster postgres -n fern-platform

# View PostgreSQL logs
kubectl logs postgres-1 -n fern-platform
```

### Connection Issues
```bash
# Verify secret exists
kubectl get secret postgres-app -n fern-platform

# Check service bindings
kubectl describe application fern-platform -n fern-platform

# Test database connection
kubectl exec -it postgres-1 -n fern-platform -- psql -U fern_user -d fern_platform
```

### KubeVela Issues
```bash
# Check application status
vela status fern-platform -n fern-platform

# View rendered resources
vela show fern-platform -n fern-platform

# Debug workflow
kubectl describe application fern-platform -n fern-platform
```

## Key Benefits

1. **Simplified Configuration**: One YAML file instead of many K8s manifests
2. **Built-in Components**: Use pre-defined types like `webservice` and `cloud-native-postgres`
3. **Dependency Management**: Workflow ensures correct deployment order
4. **Environment Abstraction**: Same app model works across dev/staging/prod

## Files Reference

- **Main definition**: `deployments/fern-platform-kubevela.yaml`
- **CNPG component**: `deployments/components/cnpg.cue`
- **Automation**: `Makefile` (see k8s-related targets)